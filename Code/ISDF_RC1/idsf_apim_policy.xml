<policies>
    <inbound>
        <base />
        <!-- mTLS gate -->
        <choose>
            <when condition="@(context.Request.Certificate == null)">
                <return-response>
                    <set-status code="401" reason="Client certificate required" />
                </return-response>
            </when>
        </choose>
        <choose>
            <when condition="@{
        var c = context.Request.Certificate;
        var now = DateTime.UtcNow;
        bool timeOk = (now >= c.NotBefore) && (now <= c.NotAfter);
        var issuer = c.Issuer ?? string.Empty;
        bool issuerOk = issuer.IndexOf("CN=OuttaTune", StringComparison.OrdinalIgnoreCase) >= 0
                     || issuer.IndexOf("CN=CirriusTech", StringComparison.OrdinalIgnoreCase) >= 0;
        return !(timeOk && issuerOk);
      }">
                <return-response>
                    <set-status code="403" reason="Invalid client certificate" />
                </return-response>
            </when>
        </choose>
        <!-- mark + audit -->
        <set-header name="x-from-apim" exists-action="override">
            <value>1</value>
        </set-header>
        <set-header name="x-client-thumbprint" exists-action="override">
            <value>@(context.Request.Certificate.Thumbprint)</value>
        </set-header>
        <set-header name="x-client-subject" exists-action="override">
            <value>@(context.Request.Certificate.Subject)</value>
        </set-header>
        <set-header name="x-correlation-id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
        <set-header name="X-ARR-ClientCert" exists-action="delete" />
        <!-- Bearer from APIM's managed identity for YOUR API (not ARM) -->
        <authentication-managed-identity resource="api://40d9edc9-d8b0-42ef-9ca1-bdc325bc9cb1" />
        <!-- Backend: host only; rewrite to /run; no SAS -->
        <set-backend-service backend-id="la-isdf-direct" />
        <rewrite-uri template="/workflows/03d4463cc1ac4aac86b635343750ac21/triggers/When_a_HTTP_request_is_received/paths/invoke" />
        <set-query-parameter name="api-version" exists-action="override">
            <value>2016-10-01</value>
        </set-query-parameter>
    </inbound>
    <backend>
        <retry count="3" interval="2" first-fast-retry="true" condition="@(
             context.Response == null ||
             (int)context.Response.StatusCode == 429 ||
             (int)context.Response.StatusCode >= 500
           )">
            <forward-request timeout="60" />
        </retry>
    </backend>
    <outbound>
        <base />
        <set-header name="x-correlation-id" exists-action="override">
            <value>@(context.RequestId.ToString())</value>
        </set-header>
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>